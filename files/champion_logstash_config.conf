#	**************************************************************************************************************************
#	This file maintains the configuration of the Logstash Inputs, Filters, and Outputs of the data acquired to feed DarkLight.
#	Initial release: "ctci_config_V6_r0" - Converted [Types] to [Tags] to support release 6.0
#	Release r1: Removed outdated and no longer used code
#	Release r2: Implemeted Syslog Input for Asus router. Revised GeoIP code to simplify. 
#	Release r3: Reverted Syslog Input back to TCP input as syslog message from Asus router does not conform to RFC3164. 
#   Release r4: Updated "#200 Filebeat csv filter AD user data" to include 'title' and 'department' data
#   Release r5: Added additional windows events 2102 and 2003, data is sent via Microsoft-Windows-DriverFrameworks-UserMode. 
#   Releast r5.5: Updated the issue with the title and department for #200 Filebeat
#   This resolves the parsing problem. Standardized section numbers. Also fixed Grok parsing error in Proxy message field.



#100 Winlogbeat & Filebeat
# Winlogbeat, Packetbeat (DNS Log) & Filebeat (Squid Proxy logs & Active Directory export CSV). Input TAG is assigned in Winlogbeat & Filebeat YML file on data shippers.

input {
	beats {
		port => 5044 
		}
	}

#103 Http Input SPLUNK

input {
    http {
    port => 8080
    codec => json
    tags => [splunk]
  }
}


#200 Filebeat csv filter AD user data.

filter {
	if "ad-users" in [tags]{
		csv{
			separator => ","
			columns => ["DN","objectClass","cn","title","whenCreated","whenChanged","memberOf","department","userAccountControl","badPwdCount","badPasswordTime","lastLogon","pwdLastSet","logonCount","sn","givenName","displayName","mail","physicalDeliveryOfficeName","telephoneNumber","l","st","postalCode","homePhone","mobile"]
			}
			}
		}	

		
#200A Filebeat csv filter AD computer data.

filter {	
	if "ad-computers" in [tags]{
		csv{
			separator => ","
			columns => ["DN","objectClass","cn","distinguishedName","instanceType","whenCreated","whenChanged","uSNCreated","memberOf","uSNChanged","name","userAccountControl","badPwdCount","badPasswordTime","lastLogoff","lastLogon","pwdLastSet","primaryGroupID","accountExpires","logonCount","operatingSystem","operatingSystemVersion","dNSHostName","isCriticalSystemObject","lastLogonTimestamp","msDS-SupportedEncryptionTypes","adminCount","description"]
			}
			}
		}
	
#202 windows event filter
#Filter that will only process windows event_ids listed below.  All others are dropped.

filter {
	if "winlogbeats" in [tags] and 
		[event_id] != 1	   and	# Sysmon Process creation
		[event_id] != 2	   and	# Sysmon A process changed a file creation time
		[event_id] != 3	   and	# Sysmon Network connection
		[event_id] != 4	   and	# Sysmon Sysmon service state changed
		[event_id] != 5	   and	# Sysmon Process terminated
		[event_id] != 6	   and	# Sysmon Driver loaded
		[event_id] != 7	   and	# Sysmon Image loaded
		[event_id] != 8	   and	# Sysmon CreateRemoteThread
		[event_id] != 9	   and	# Sysmon RawAccessRead
		[event_id] != 10   and	# Sysmon ProcessAccess
		[event_id] != 11   and	# Sysmon FileCreate
		[event_id] != 12   and	# Sysmon RegistryEvent (Object create and delete)
		[event_id] != 13   and	# Sysmon RegistryEvent (Value Set) 
		[event_id] != 14   and	# Sysmon RegistryEvent (Key and Value Rename)
		[event_id] != 15   and	# Sysmon FileCreateStreamHash
		[event_id] != 17   and	# Sysmon PipeEvent (Pipe Created)
		[event_id] != 18   and	# Sysmon PipeEvent (Pipe Connected)
		[event_id] != 19   and	# Sysmon WmiEvent (WmiEventFilter activity detected)
		[event_id] != 20   and	# Sysmon WmiEvent (WmiEventConsumer activity detected)
		[event_id] != 21   and	# Sysmon WmiEvent (WmiEventConsumerToFilter activity detected)
		[event_id] != 255  and	# Sysmon Error		
		[event_id] != 104  and	# The Application or System log was cleared
		[event_id] != 106  and	# New Scheduled Job
		[event_id] != 2102 and  # Microsoft-Windows-DriverFrameworks-UserMode USB: On Unplug: Pnp or Power Management operation to a particular device.
		[event_id] != 2003 and  # Microsoft-Windows-DriverFrameworks-UserMode USB: On Plugin: Loading drivers to control a newly discovererd device.
		[event_id] != 4697 and	# New Sevice Installed
		[event_id] != 4698 and	# New Scheduled Task Created
		[event_id] != 40   and	# Issue with Driver
		[event_id] != 6009 and	# Lists OS version, Service Pack and processor type
		[event_id] != 1022 and	# Windows Installer updated the product
		[event_id] != 1033 and	# Windows Installer installed the product
		[event_id] != 1034 and	# Windows Installer removed the product
		[event_id] != 18   and	# Windows Update - Ready
		[event_id] != 19   and	# Windows Update - Installed
		[event_id] != 20   and	# Windows Update - Failure
		[event_id] != 35   and	# Time Service sync status and source
		[event_id] != 200  and	# Windows PowerShell Log
		[event_id] != 400  and	# Windows PowerShell Log
		[event_id] != 500  and	# Windows PowerShell Log
		[event_id] != 501  and	# Windows PowerShell Log
		[event_id] != 4103 and	# Windows PowerShell Log - Payloads
		[event_id] != 4104 and	# Windows PowerShell Log - ScriptBlockText
		[event_id] != 1000 and	# Application Fault
		[event_id] != 2004 and	# Windows Firewall Rule added
		[event_id] != 2005 and	# Windows Firewall Rule modified
		[event_id] != 2006 and	# Windows Firewall Rule deleted
		
		[event_id] != 4720 and	# A user account was created
		[event_id] != 4724 and	# An attempt was made to reset an accounts PW
		[event_id] != 4735 and	# Local Group changed
		[event_id] != 4738 and	# User account password changed
		[event_id] != 7000 and  # The XYX service failed to start due to the following error: The service did not respond to the start or control request in a timely fashion
		[event_id] != 7022 and	# The XYZ service hung on starting
		[event_id] != 7023 and	# The XYZ service failed
		[event_id] != 7024 and	# The XYZ service terminated with service-specific error %%2414
		[event_id] != 7031 and	# The XYZ service terminated unexpectedly. It has done this 1 time(s). The following corrective action will be taken in 60000 milliseconds: Restart the service
		[event_id] != 7034 and	# The XYZ service terminated unexpectedly. It has done this 1 time(s)
		[event_id] != 7035 and	# Service sent a request to Stop or Start
		[event_id] != 7036 and	# Service was Started or Stopped  - System log
		[event_id] != 7040 and	# The start type of the XYZ service was changed from auto start to disabled
		[event_id] != 7042 and	# The XYZ service stopped
		[event_id] != 7045 and	# A service was installed in the system
		
		[event_id] != 4719 and	# System audit policy was changed
		[event_id] != 4656 and	# A Handle to an object was requested		
#		[event_id] != 4657 and	# A Registry value was modified
		[event_id] != 4658 and	# The Handle to an object was closed
 		[event_id] != 6281 and  # Page hashes of an image file are not valid
		
		[event_id] != 1102 and	# The Security audit log was cleared
		[event_id] != 4624 and	# An account was successfully logged on
		[event_id] != 4625 and	# An account failed to log on
		[event_id] != 4634 and	# An account was successfully logged off
		[event_id] != 4648 and	# A logon was attempted using explicit credentials
#		[event_id] != 4663 and	# Accesses: WriteData (or AddFile)
		[event_id] != 4672 and	# Special privileges assigned to new logon.
		[event_id] != 4688 and	# New Process Name, look for Creator Process ID to link what process launched what
		[event_id] != 4689 and	# A process has exited.		
		[event_id] != 4698 and	# A scheduled task was created.
		[event_id] != 4732 and	# A member was added to a security-enabled local group.
		[event_id] != 4738 and	# A user account was changed.
		[event_id] != 4740 and	# A user account was locked out.
		[event_id] != 4768 and	# A Kerberos authentication ticket (TGT) was requested.
		[event_id] != 4798 and	# A user's local group membership was enumerated.
		[event_id] != 4799 and	# A security-enabled local group membership was enumerated.		
		[event_id] != 4964 and	# Special groups have been assinged to a new logon.
		[event_id] != 5025 and 	# The Windows Firewall Service failed to start.
		[event_id] != 5030 and 	# A network share object was accessed.
		[event_id] != 5140 and 	# A network share object was accessed.
		[event_id] != 5145 and	# A network share object was checked to see whether client can be granted desired access.
		[event_id] != 5152 and  # A packet was blocked by the Windows Filtering Platform
		[event_id] != 5156 and  # The Windows Filtering Platform (Fire Wall) has allowed a connection.
		[event_id] != 10148 and # The Windows Remote Management Service has been enabled (source System Log).
		[event_id] != 10149     # The Windows Remote Management Service has been stopped (source System Log).
		{
		drop {}
		}

	}


#203 Win Event 5156, The Windows Filtering Platform (Fire Wall) has allowed a connection
#Exclusion Filter - Excludes events with the Application_Name listed as they are white listed.

filter {
	if "winlogbeats" in [tags] and [event_id] == 5156 and
	[event_data][Application] =~ /svchost\.exe/ or
	[event_data][Application] =~ /System/ or
	[event_data][Application] =~ /darklight\.exe/ or
	[event_data][Application] =~ /winlogbeat\.exe/ or
	[event_data][Application] =~ /packetbeat\.exe/ or
	[event_data][Application] =~ /ucmapi\.exe/ or
	[event_data][Application] =~ /lync\.exe/ or
	[event_data][Application] =~ /teamviewer_service\.exe/ or
	[event_data][Application] =~ /mdnsresponder\.exe/ or
	[event_data][Application] =~ /sharedservicehost\.exe/ or
	[event_data][Application] =~ /lsass\.exe/ or
	[event_data][Application] =~ /webservices\.exe/ or
	[event_data][Application] =~ /smsvchost\.exe/ or
	[event_data][Application] =~ /cylancesvc\.exe/ or
	[event_data][Application] =~ /slack\.exe/ or
	[event_data][Application] =~ /dropbox\.exe/ or
	[event_data][Application] =~ /dropboxupdate\.exe/ or
	[event_data][Application] =~ /lpsvc\.exe/ or
	[event_data][Application] =~ /winword\.exe/ or
	[event_data][Application] =~ /officeclicktorun\.exe/ or
	[event_data][Application] =~ /mediastreamingprovider\.exe/ or
	[event_data][Application] =~ /taskhost\.exe/ or
	[event_data][Application] =~ /httpd\.exe/ or
	[event_data][Application] =~ /dlserver\.exe/ or
	[event_data][Application] =~ /dns\.exe/ or
	[event_data][Application] =~ /spotify\.exe/ or
	[event_data][Application] =~ /wseclientsvc\.exe/ or
	[event_data][Application] =~ /firefox\.exe/ or
	[event_data][Application] =~ /outlook\.exe/ or
	[event_data][Application] =~ /onenote\.exe/ or
	[event_data][Application] =~ /spoolsv\.exe/ or
	[event_data][Application] =~ /runtask\.exe/ or
	[event_data][Application] =~ /microsoftedgecp\.exe/ or
	[event_data][Application] =~ /storageservice\.exe/ or
	[event_data][Application] =~ /searchui\.exe/ or
	[event_data][Application] =~ /msosync\.exe/ or
	[event_data][Application] =~ /wmiprvse\.exe/ or
	[event_data][Application] =~ /wmic\.exe/ or
	[event_data][Application] =~ /dllhost\.exe/ or
	[event_data][Application] =~ /javaw\.exe/ or
	[event_data][Application] =~ /java\.exe/ or
	[event_data][Application] =~ /w3wp\.exe/ or
	[event_data][Application] =~ /SearchFilterHost\.exe/ or
	[event_data][Application] =~ /searchprotocolhost\.exe/ or	
	[event_data][Application] =~ /HPNetworkCommunicator\.exe/ or
	[event_data][Application] =~ /git\.exe/ or	
	[event_data][Application] =~ /audiodg\.exe/ or		
	[event_data][Application] =~ /taskhostw\.exe/ or	
	[event_data][Application] =~ /splunkd\.exe/ or	
	[event_data][Application] =~ /splunk-winprintmon\.exe/ or	
	[event_data][Application] =~ /splunk-regmon\.exe/ or	
	[event_data][Application] =~ /splunk-admon\.exe/ or	
	[event_data][Application] =~ /splunk-netmon\.exe/ or	
	[event_data][Application] =~ /splunk-MonitorNoHandle\.exe/ or
	[event_data][Application] =~ /GoogleUpdate\.exe/ or	
	[event_data][Application] =~ /taskeng\.exe/ or	
	[event_data][Application] =~ /TrustedInstaller\.exe/ or	
	[event_data][Application] =~ /chrome\.exe/ or	
	[event_data][Application] =~ /Askpass\.exe/ or	
	[event_data][Application] =~ /dashost\.exe/ or	
	[event_data][Application] =~ /groove\.exe/ or	
	[event_data][Application] =~ /onedrive\.exe/ or	
	[event_data][Application] =~ /dfssvc\.exe/ or	
	[event_data][Application] =~ /dfsrs\.exe/ or
	[event_data][Application] =~ /wifitask\.exe/ or	
	[event_data][Application] =~ /wssbackup\.exe/ or	
	[event_data][Application] =~ /git-remote-https\.exe/ or	
	[event_data][Application] =~ /sh\.exe/ or	
	[event_data][Application] =~ /HPNetworkCommunicatorCom\.exe/ or	
	[event_data][Application] =~ /RdrCEF\.exe/ or	
	[event_data][Application] =~ /backgroundTaskHost\.exe/
		{
		drop {}
		}
}


#206 Win Event 4688 Exclusion Filter - Excludes events with the process names listed as they are white listed.
filter {
	if "winlogbeats" in [tags] and [event_id] == 4688 and
	[event_data][NewProcessName] =~ /conhost\.exe/ or
	[event_data][NewProcessName] =~ /WmiPrvSE\.exe/ or
	[event_data][NewProcessName] =~ /WMIC\.exe/ or
	[event_data][NewProcessName] =~ /dllhost\.exe/ or
	[event_data][NewProcessName] =~ /javaw\.exe/ or
	[event_data][NewProcessName] =~ /java\.exe/ or
	[event_data][NewProcessName] =~ /w3wp\.exe/ or
	[event_data][NewProcessName] =~ /SearchFilterHost\.exe/ or
	[event_data][NewProcessName] =~ /SearchProtocolHost\.exe/ or	
	[event_data][NewProcessName] =~ /HPNetworkCommunicator\.exe/ or
	[event_data][NewProcessName] =~ /git\.exe/ or	
	[event_data][NewProcessName] =~ /audiodg\.exe/ or		
	[event_data][NewProcessName] =~ /taskhostw\.exe/ or	
	[event_data][NewProcessName] =~ /splunk-winprintmon\.exe/ or	
	[event_data][NewProcessName] =~ /splunk-regmon\.exe/ or	
	[event_data][NewProcessName] =~ /splunk-admon\.exe/ or	
	[event_data][NewProcessName] =~ /splunk-netmon\.exe/ or	
	[event_data][NewProcessName] =~ /splunk-MonitorNoHandle\.exe/ or
	[event_data][NewProcessName] =~ /GoogleUpdate\.exe/ or	
	[event_data][NewProcessName] =~ /taskeng\.exe/ or	
	[event_data][NewProcessName] =~ /TrustedInstaller\.exe/ or	
	[event_data][NewProcessName] =~ /chrome\.exe/ or	
	[event_data][NewProcessName] =~ /Askpass\.exe/ or	
	[event_data][NewProcessName] =~ /git-remote-https\.exe/ or	
	[event_data][NewProcessName] =~ /sh\.exe/ or	
	[event_data][NewProcessName] =~ /HPNetworkCommunicatorCom\.exe/ or	
	[event_data][NewProcessName] =~ /RdrCEF\.exe/ or	
	[event_data][NewProcessName] =~ /backgroundTaskHost\.exe/
		{
		drop {}
	}
}


#207 Apache access combined format filter
filter {
  	if "apache_access" in [tags]{
    grok {
      match => { "message" => "%{COMBINEDAPACHELOG}" }
		}
    if "_grokparsefailure" in [tags] {
      drop { }
		}
  
  date {
    match => [ "timestamp" , "dd/MMM/yyyy:HH:mm:ss Z"]
	locale => ["en-US"]
		}
	}
}

#209 Win Event 4672 Filter
# Parses PrivilegeList in greater detail

filter {
  if "winlogbeats" in [tags] and [event_id] == 4672
  {
    # 1st add pipe to end of each line:
    mutate {
      gsub => [ "[event_data][PrivilegeList]" , "$", "|" ]
    }
    # create array items by splitting on pipes:
    mutate {
      split => { "[event_data][PrivilegeList]" => "|" }
    }
    # finally remove whitespace from each array item:
    mutate {
      strip => [ "[event_data][PrivilegeList]"  ]
    }
  }
}

#210 OsQuery JSON filter

filter {
	if "osquery" in [tags]{
	json {
		source => "message"
		skip_on_invalid_json => true
		}
	}
}	

#211 GeoIP Filter.  Geolocate IP addresses from data elements listed, ignores private IP addresses i.e. RFC1918 addresses.  Note there is a separate instance of "geoip" for each data element.  GeoIP filter can only process the "source" field with one element, if the data is in an array only the first element is processed.

filter {
		if  
			[event_data][DestAddress] 	or		#From Winevent logs
			[event_data][SourceAddress] or		#From Winevent logs
			[event_data][DestinationIp]	or		#From Winevent logs
			[event_data][SourceIp]		or		#From Winevent logs
			["SRC"]						or		#From Router Syslog
			["clientip"]				or		#From Apache logs
			[dest][ip]					or		#From Flow logs
			[source][ip]				or		#From Flow logs
			[dest][ipv6]				or		#From Flow logs
			["domain"]					or		#From Squid Proxy logs
			[source][ipv6]						#From Flow logs

			!~ "(^127\.0\.0\.1)|(^10\.)|(^172\.1[6-9]\.)|(^172\.2[0-9]\.)|(^172\.3[0-1]\.)|(^192\.168\.)|(^169\.254\.)"
			
			{
			geoip {			
				cache_size => 3000
				database =>  "/var/local/geoip/GeoLite2-City.mmdb"
				source => ["[event_data][DestAddress]"]
				}
			geoip {
				cache_size => 3000
				database =>  "/var/local/geoip/GeoLite2-City.mmdb"
				source => ["[event_data][SourceAddress]"]
				}
			geoip {
				cache_size => 3000
				database =>  "/var/local/geoip/GeoLite2-City.mmdb"
				source => ["[event_data][DestinationIp]"]
				}
			geoip {
				cache_size => 3000
				database =>  "/var/local/geoip/GeoLite2-City.mmdb"
				source => ["[event_data][SourceIp]"]
				}
			geoip {
				cache_size => 3000
				database =>  "/var/local/geoip/GeoLite2-City.mmdb"
				source => ["SRC"]
				}
			geoip {
				cache_size => 3000
				database =>  "/var/local/geoip/GeoLite2-City.mmdb"
				source => ["clientip"]
				}
			geoip {
				cache_size => 3000
				database =>  "/var/local/geoip/GeoLite2-City.mmdb"
				source => ["[dest][ip]"]
				}
			geoip {
				cache_size => 3000
				database =>  "/var/local/geoip/GeoLite2-City.mmdb"
				source => ["[source][ip]"]
				}
			geoip {
				cache_size => 3000
				database =>  "/var/local/geoip/GeoLite2-City.mmdb"
				source => ["[dest][ipv6]"]
				}
			geoip {
				cache_size => 3000
				database =>  "/var/local/geoip/GeoLite2-City.mmdb"
				source => ["domain"]
				}	
			geoip {
				cache_size => 3000
				database =>  "/var/local/geoip/GeoLite2-City.mmdb"
				source => ["[source][ipv6]"]
				}				
			}
		}	

	
		
#212 Etraneous noisy tag cleanup.  Removes non-value tags from output.

filter {
    if "beats_input_codec_plain_applied" in [tags] {
        mutate {
            remove_tag => ["beats_input_codec_plain_applied"]
        }
		}
	if "_geoip_lookup_failure" in [tags] {
        mutate {
            remove_tag => ["_geoip_lookup_failure"]
        }	
    }
}


#301 Winevent output to Elasticsearch -> Kibana

output {
  if "winlogbeats" in [tags] {
		elasticsearch {
			hosts => ["localhost:9200"]
			index => "%{[@metadata][beat]}-%{[@metadata][version]}-%{+YYYY.MM.dd}"
			}
		}
	}

	
#302 apache access output

output {
  	if "apache_access" in [tags]{
		elasticsearch {
			manage_template => false
			hosts => ["localhost:9200"]
			index => "apache-%{+YYYY.MM.dd}"
			}
		}
	}

	
#304 Http Output Splunk WinEvents

output {
	if "splunk" in [tags] and [search_name] == "Windows_Events" {
			elasticsearch {
			manage_template => false
			hosts => ["localhost:9200"]
			index => "splunk_winevent-%{+YYYY.MM.dd}"
			}
		}
	}

	
#306 DNS data - Packtbeat Output

output {
 if "dns" in [tags] and [type] != "flow" {
		elasticsearch {
			hosts => ["localhost:9200"]
			index => "dns-%{[@metadata][version]}-%{+YYYY.MM.dd}"
			}
		}
	}

	
#307 Flow data - Packtbeat Output

output {
 if "dns" in [tags] and [type] == "flow" {
		elasticsearch {
			hosts => ["localhost:9200"]
			index => "flow-%{[@metadata][version]}-%{+YYYY.MM.dd}"
			}
		}
	}

	
#308 Active Directory Users & Computers output

output {
	if "ad-computers" in [tags]{
		elasticsearch {
			hosts => ["localhost:9200"]
			index => "ad-computers-%{[@metadata][version]}-%{+YYYY.MM.dd}"
			}
		}
		
	if "ad-users" in [tags]{
		elasticsearch {
			hosts => ["localhost:9200"]
			index => "ad-users-%{[@metadata][version]}-%{+YYYY.MM.dd}"
			}
		}
	}	

	
#309 OsQuery output

output {
	if "osquery" in [tags]{
		elasticsearch {
			hosts => ["localhost:9200"]
			index => "osquery-%{+YYYY.MM.dd}"
			}
		}
	}	

	
#310 Output all data to message queue AMQ via Stomp plugin

output{
   stomp {
		destination => "Champ.Ingest"
		host => "localhost"
		codec => "json"
		}
	}