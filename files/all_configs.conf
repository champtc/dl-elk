

#101 Winlogbeat & Filebeat
input {
	beats {
		port => 5044 # Winlogbeat input
		# Type is assigned in winlogbeat YML file on shipper
	}
}



#105 Http Input
#input {
#  http {
#    type => "http"
#  }
#}


#201 win event filter
#filter to only process windows event_id listed below.  All others are dropped.

filter {
	if [type] == "wineventlog" and 
		[event_id] != 104  and	# The Application or System log was cleared
		[event_id] != 106  and	# New Scheduled Job
		[event_id] != 4697 and	# New Sevice Installed
		[event_id] != 4698 and	# New Task Created
		[event_id] != 40   and	# Issue with Driver
		[event_id] != 6009 and	# Lists OS version, Service Pack and processor type
		[event_id] != 1022 and	# Windows Installer updated the product
		[event_id] != 1033 and	# Windows Installer installed the product
		[event_id] != 1034 and	# Windows Installer removed the product
		[event_id] != 18   and	# Windows Update - Ready
		[event_id] != 19   and	# Windows Update - Installed
		[event_id] != 20   and	# Windows Update - Failure
		[event_id] != 35   and	# Time Service sync status and source
		[event_id] != 200  and	# Windows PowerShell Log
		[event_id] != 400  and	# Windows PowerShell Log
		[event_id] != 500  and	# Windows PowerShell Log
		[event_id] != 501  and	# Windows PowerShell Log
		[event_id] != 4103 and	# Windows PowerShell Log - Payloads
		[event_id] != 4104 and	# Windows PowerShell Log - ScriptBlockText
		[event_id] != 1000 and	# Application Fault
		[event_id] != 2004 and	# Windows Firewall Rule added
		[event_id] != 2005 and	# Windows Firewall Rule modified
		[event_id] != 2006 and	# Windows Firewall Rule deleted
		
		[event_id] != 4720 and	# A user account was created
		[event_id] != 4724 and	# An attempt was made to reset an accounts PW
		[event_id] != 4735 and	# Local Group changed
		[event_id] != 4738 and	# User account password changed
		[event_id] != 7000 and  # The XYX service failed to start due to the following error: The service did not respond to the start or control request in a timely fashion
		[event_id] != 7022 and	# The XYZ service hung on starting
		[event_id] != 7023 and	# The XYZ service failed
		[event_id] != 7024 and	# The XYZ service terminated with service-specific error %%2414
		[event_id] != 7031 and	# The XYZ service terminated unexpectedly. It has done this 1 time(s). The following corrective action will be taken in 60000 milliseconds: Restart the service
		[event_id] != 7034 and	# The XYZ service terminated unexpectedly. It has done this 1 time(s)
		[event_id] != 7035 and	# Service sent a request to Stop or Start
		[event_id] != 7036 and	# Service was Started or Stopped  - System log
		[event_id] != 7040 and	# The start type of the XYZ service was changed from auto start to disabled
		[event_id] != 7042 and	# The XYZ service stopped
		[event_id] != 7045 and	# A service was installed in the system
		
		[event_id] != 4719 and	# System audit policy was changed
#		[event_id] != 4657 and	# A Registry value was modified
 		[event_id] != 6281 and  # Page hashes of an image file are not valid
		
		[event_id] != 1102 and	# The Security audit log was cleared
		[event_id] != 4624 and	# An account was successfully logged on
		[event_id] != 4625 and	# An account failed to log on
		[event_id] != 4634 and	# An account was successfully logged off
		[event_id] != 4648 and	# A logon was attempted using explicit credentials
# 		[event_id] != 4663 and	# Accesses: WriteData (or AddFile)
		[event_id] != 4672 and	# Special privileges assigned to new logon.
		[event_id] != 4688 and	# New Process Name, look for Creator Process ID to link what process launched what
		[event_id] != 4732 and	# A member was added to a security-enabled local group.
		[event_id] != 4738 and	# A user account was changed.
		[event_id] != 4740 and	# A user account was locked out.
		[event_id] != 4768 and	# A Kerberos authentication ticket (TGT) was requested.
		[event_id] != 4798 and	# A user's local group membership was enumerated.
		[event_id] != 5025 and 	# The Windows Firewall Service failed to start.
		[event_id] != 5030 and 	# A network share object was accessed.
		[event_id] != 5140 and 	# A network share object was accessed.
		[event_id] != 5145 and	# A network share object was checked to see whether client can be granted desired access.
		[event_id] != 5152 and  # A packet was blocked by the Windows Filtering Platform
		[event_id] != 5156 	    # The Windows Filtering Platform (Fire Wall) has allowed a connection.
		{
		drop {}
	}
}

#201-A Win Event 5156, The Windows Filtering Platform (Fire Wall) has allowed a connection
#Exclusion Filter - Excludes events with the Application_Name listed as they are white listed.

filter {
	if [type] == "wineventlog" and [event_id] == 5156 and

	[event_data][Application] =~ /svchost\.exe/ or
	[event_data][Application] =~ /System/ or
	[event_data][Application] =~ /darklight\.exe/ or
	[event_data][Application] =~ /winlogbeat\.exe/ or
	[event_data][Application] =~ /packetbeat\.exe/ or
	[event_data][Application] =~ /ucmapi\.exe/ or
	[event_data][Application] =~ /lync\.exe/ or
	[event_data][Application] =~ /teamviewer_service\.exe/ or
	[event_data][Application] =~ /mdnsresponder\.exe/ or
	[event_data][Application] =~ /sharedservicehost\.exe/ or
	[event_data][Application] =~ /lsass\.exe/ or
	[event_data][Application] =~ /webservices\.exe/ or
	[event_data][Application] =~ /smsvchost\.exe/ or
	[event_data][Application] =~ /cylancesvc\.exe/ or
	[event_data][Application] =~ /slack\.exe/ or
	[event_data][Application] =~ /dropbox\.exe/ or
	[event_data][Application] =~ /dropboxupdate\.exe/ or
	[event_data][Application] =~ /lpsvc\.exe/ or
	[event_data][Application] =~ /winword\.exe/ or
	[event_data][Application] =~ /officeclicktorun\.exe/ or
	[event_data][Application] =~ /mediastreamingprovider\.exe/ or
	[event_data][Application] =~ /taskhost\.exe/ or
	[event_data][Application] =~ /httpd\.exe/ or
	[event_data][Application] =~ /dlserver\.exe/ or
	[event_data][Application] =~ /dns\.exe/ or
	[event_data][Application] =~ /spotify\.exe/ or
	[event_data][Application] =~ /wseclientsvc\.exe/ or
	[event_data][Application] =~ /firefox\.exe/ or
	[event_data][Application] =~ /outlook\.exe/ or
	[event_data][Application] =~ /onenote\.exe/ or
	[event_data][Application] =~ /spoolsv\.exe/ or
	[event_data][Application] =~ /runtask\.exe/ or
	[event_data][Application] =~ /microsoftedgecp\.exe/ or
	[event_data][Application] =~ /storageservice\.exe/ or
	[event_data][Application] =~ /searchui\.exe/ or
	[event_data][Application] =~ /msosync\.exe/ or
	[event_data][Application] =~ /wmiprvse\.exe/ or
	[event_data][Application] =~ /wmic\.exe/ or
	[event_data][Application] =~ /dllhost\.exe/ or
	[event_data][Application] =~ /javaw\.exe/ or
	[event_data][Application] =~ /java\.exe/ or
	[event_data][Application] =~ /w3wp\.exe/ or
	[event_data][Application] =~ /SearchFilterHost\.exe/ or
	[event_data][Application] =~ /searchprotocolhost\.exe/ or	
	[event_data][Application] =~ /HPNetworkCommunicator\.exe/ or
	[event_data][Application] =~ /git\.exe/ or	
	[event_data][Application] =~ /audiodg\.exe/ or		
	[event_data][Application] =~ /taskhostw\.exe/ or	
	[event_data][Application] =~ /splunkd\.exe/ or	
	[event_data][Application] =~ /splunk-winprintmon\.exe/ or	
	[event_data][Application] =~ /splunk-regmon\.exe/ or	
	[event_data][Application] =~ /splunk-admon\.exe/ or	
	[event_data][Application] =~ /splunk-netmon\.exe/ or	
	[event_data][Application] =~ /splunk-MonitorNoHandle\.exe/ or
	[event_data][Application] =~ /GoogleUpdate\.exe/ or	
	[event_data][Application] =~ /taskeng\.exe/ or	
	[event_data][Application] =~ /TrustedInstaller\.exe/ or	
	[event_data][Application] =~ /chrome\.exe/ or	
	[event_data][Application] =~ /Askpass\.exe/ or	
	[event_data][Application] =~ /dashost\.exe/ or	
	[event_data][Application] =~ /groove\.exe/ or	
	[event_data][Application] =~ /onedrive\.exe/ or	
	[event_data][Application] =~ /dfssvc\.exe/ or	
	[event_data][Application] =~ /dfsrs\.exe/ or
	[event_data][Application] =~ /wifitask\.exe/ or	
	[event_data][Application] =~ /wssbackup\.exe/ or	
	[event_data][Application] =~ /git-remote-https\.exe/ or	
	[event_data][Application] =~ /sh\.exe/ or	
	[event_data][Application] =~ /HPNetworkCommunicatorCom\.exe/ or	
	[event_data][Application] =~ /RdrCEF\.exe/ or	
	[event_data][Application] =~ /backgroundTaskHost\.exe/
		{
		drop {}
		}
	geoip {
		source => ["[event_data][DestAddress]"]
		database => "/var/local/geoip/GeoLite2-City.mmdb"
		}
}


#202 filter filebeat-syslog - used to collect syslog data from Mac computers
#filter {
#  if [type] == "mac_log" {
#      grok {
#        match => { "message" => "%{SYSLOGTIMESTAMP:syslog_timestamp} %{SYSLOGHOST:syslog_hostname} %{DATA:syslog_program}(?:\[%{POSINT:syslog_pid}\])?: %{GREEDYDATA:syslog_message}" }
#			add_field => [ "received_at", "%{@timestamp}" ]
#			add_field => [ "received_from", "%{host}" ]
#    }
#      syslog_pri { }
#      date {
#        match => [ "syslog_timestamp", "MMM  d HH:mm:ss", "MMM dd HH:mm:ss" ]
#      }
#    }
#}





#205 Win Event 4688 Exclusion Filter - Excludes events with the process names listed as they are white listed.
filter {
	if [type] == "wineventlog" and [event_id] == 4688 and

	[event_data][NewProcessName] =~ /conhost\.exe/ or
	[event_data][NewProcessName] =~ /WmiPrvSE\.exe/ or
	[event_data][NewProcessName] =~ /WMIC\.exe/ or
	[event_data][NewProcessName] =~ /dllhost\.exe/ or
	[event_data][NewProcessName] =~ /javaw\.exe/ or
	[event_data][NewProcessName] =~ /java\.exe/ or
	[event_data][NewProcessName] =~ /w3wp\.exe/ or
	[event_data][NewProcessName] =~ /SearchFilterHost\.exe/ or
	[event_data][NewProcessName] =~ /SearchProtocolHost\.exe/ or	
	[event_data][NewProcessName] =~ /HPNetworkCommunicator\.exe/ or
	[event_data][NewProcessName] =~ /git\.exe/ or	
	[event_data][NewProcessName] =~ /audiodg\.exe/ or		
	[event_data][NewProcessName] =~ /taskhostw\.exe/ or	
	[event_data][NewProcessName] =~ /splunk-winprintmon\.exe/ or	
	[event_data][NewProcessName] =~ /splunk-regmon\.exe/ or	
	[event_data][NewProcessName] =~ /splunk-admon\.exe/ or	
	[event_data][NewProcessName] =~ /splunk-netmon\.exe/ or	
	[event_data][NewProcessName] =~ /splunk-MonitorNoHandle\.exe/ or
	[event_data][NewProcessName] =~ /GoogleUpdate\.exe/ or	
	[event_data][NewProcessName] =~ /taskeng\.exe/ or	
	[event_data][NewProcessName] =~ /TrustedInstaller\.exe/ or	
	[event_data][NewProcessName] =~ /chrome\.exe/ or	
	[event_data][NewProcessName] =~ /Askpass\.exe/ or	
	[event_data][NewProcessName] =~ /git-remote-https\.exe/ or	
	[event_data][NewProcessName] =~ /sh\.exe/ or	
	[event_data][NewProcessName] =~ /HPNetworkCommunicatorCom\.exe/ or	
	[event_data][NewProcessName] =~ /RdrCEF\.exe/ or	
	[event_data][NewProcessName] =~ /backgroundTaskHost\.exe/
		{
		drop {}
	}
}



# 206 Http Filter
#filter {
#  if [type]=="http" {
#    json {
#      source=>"message"
#    } 
#  }
#}




#210 Win Event 4672 Filter
# Parses PrivilegeList in greater detail

filter {
  if [type] == "wineventlog" and  [event_id] == 4672
  {
    # 1st add pipe to end of each line:
    mutate {
      gsub => [ "[event_data][PrivilegeList]" , "$", "|" ]
    }
    # create array items by splitting on pipes:
    mutate {
      split => { "[event_data][PrivilegeList]" => "|" }
    }
    # finally remove whitespace from each array item:
    mutate {
      strip => [ "[event_data][PrivilegeList]"  ]
    }
  }
}



# 302 Winevent output
output {
  if [type] == "wineventlog"  {
		elasticsearch {
			hosts => ["localhost:9200"]
			index => "winlogbeat-%{+YYYY.MM.dd}"
    }
  }
}


#306 Http Output
#output {
#   if [type] == "http" {
#                elasticsearch {
#                  hosts => ["localhost:9200"]
#                  index => "http-%{+YYYY.MM.dd}"
#                }
#        }
#}


# message queue output queue-per-type
#output{
#  stomp {
#    destination => "Champ.Ingest.%{type}"
#    host => "localhost"
#    codec => "json"
#  }
#}






